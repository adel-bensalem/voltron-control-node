- name: Find available port
  shell: |
    PORT=5000
    while true; do
      ss -tulpen | grep ":${PORT}" &> /dev/null
      if [[ "$?" == "1" ]]; then
        echo "${PORT}"
        exit
      fi
      ((PORT++))
    done
  args:
    executable: /bin/bash
  register: port

- name: Build image
  shell: sudo docker build -t "{{ application_name }}:latest" "{{ repositories_path }}/{{ application_name }}"

- name: Run container
  shell: sudo docker run -d -p "{{ port.stdout }}:80" --name "{{ application_name }}" "{{ application_name }}:latest"
  set_fact:
    portMap: "{{ portMap | default({}) | combine ({ application_name : port.stdout }) }}"
